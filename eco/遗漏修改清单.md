# 遗漏修改清单

## 🔍 **全项目检查结果**

经过全面检查，发现以下遗漏的修改：

### ✅ **已完成的修改**
1. **RewardConstructor.java** - 总算力计算
2. **PurchaseMinerProjectServiceImpl.java** - 矿机购买算力统计
3. **RecommendServiceImpl.java** - 推荐关系算力统计
4. **PurchaseMinerProjectScheduled.java** - 定时任务算力更新

### ❌ **遗漏的修改**

#### 1. **RewardConstructor.java** - 动态奖励方法
**问题：** 动态奖励方法还在使用 `RecommendStatisticsLogDTO`，需要改为使用 `ComputingPowerDTO`

**需要修改的方法：**
- `recommendReward()` - 动态推荐奖励
- `baseReward()` - 动态小区奖励  
- `newReward()` - 动态新增奖励

**修改内容：**
```java
// 原方法签名
public SingleResponse<Void> recommendReward(BigDecimal dynamicTotalReward,
                                            List<RecommendStatisticsLogDTO> recommendStatisticsLogList,
                                            String dayTime,
                                            List<PurchaseMinerProjectReward> rewardList)

// 新方法签名
public SingleResponse<Void> recommendReward(BigDecimal dynamicTotalReward,
                                            List<ComputingPowerDTO> computingPowerList,
                                            String dayTime,
                                            List<PurchaseMinerProjectReward> rewardList)
```

#### 2. **控制器层** - 用户查询接口
**文件：**
- `RecommendStatisticsLogController.java`
- `AdminRecommendStatisticsLogController.java`

**问题：** 还在使用 `RecommendStatisticsLogService`，需要改为使用 `ComputingPowerService`

**修改内容：**
```java
@Resource
private ComputingPowerService computingPowerService;

@PostMapping("/info")
SingleResponse<RecommendStatisticsLogDTO> get(@RequestBody RecommendStatisticsLogQry recommendStatisticsLogQry) {
    String dayTime = recommendStatisticsLogQry.getDayTime();
    if (dayTime == null || dayTime.trim().isEmpty()) {
        dayTime = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd"));
    }
    
    SingleResponse<ComputingPowerDTO> response = computingPowerService.getComputingPowerInfo(
        recommendStatisticsLogQry.getWalletAddress(), dayTime);
    
    if (response.isSuccess()) {
        RecommendStatisticsLogDTO dto = convertToOldFormat(response.getData());
        return SingleResponse.of(dto);
    }
    
    return SingleResponse.buildFailure(response.getErrMessage());
}
```

#### 3. **依赖注入** - 缺少必要的服务注入
**需要添加的依赖：**
```java
@Resource
private ComputingPowerService computingPowerService;

@Resource
private ComputingPowerServiceImplV2 computingPowerServiceV2;
```

**需要添加依赖的文件：**
- `RewardConstructor.java`
- `PurchaseMinerProjectServiceImpl.java`
- `RecommendServiceImpl.java`
- `PurchaseMinerProjectScheduled.java`
- `RecommendStatisticsLogController.java`
- `AdminRecommendStatisticsLogController.java`

#### 4. **缓存清除** - 启用缓存清除功能
**需要取消注释的代码：**
```java
// 在以下文件中取消注释
computingPowerServiceV2.invalidateUserCache(walletAddress);
```

**文件位置：**
- `PurchaseMinerProjectServiceImpl.java` 第282行
- `RecommendServiceImpl.java` 第166行
- `PurchaseMinerProjectScheduled.java` 第60行和第115行
- `RewardConstructor.java` 第1354行

#### 5. **导入语句** - 添加必要的导入
**需要添加的导入：**
```java
import com.example.eco.bean.dto.ComputingPowerDTO;
import com.example.eco.core.service.ComputingPowerService;
import com.example.eco.core.service.impl.ComputingPowerServiceImplV2;
import com.example.eco.util.ComputingPowerUtil;
```

## 🚀 **修改优先级**

### **高优先级（必须修改）**
1. **RewardConstructor.java** - 动态奖励方法
2. **依赖注入** - 添加必要的服务注入
3. **缓存清除** - 启用缓存清除功能

### **中优先级（建议修改）**
1. **控制器层** - 用户查询接口
2. **导入语句** - 添加必要的导入

### **低优先级（可选修改）**
1. **清理代码** - 删除不再使用的 `RecommendStatisticsLogService` 相关代码

## 📋 **修改检查清单**

- [ ] RewardConstructor.java - 动态奖励方法签名和实现
- [ ] RewardConstructor.java - 添加依赖注入
- [ ] PurchaseMinerProjectServiceImpl.java - 添加依赖注入
- [ ] RecommendServiceImpl.java - 添加依赖注入
- [ ] PurchaseMinerProjectScheduled.java - 添加依赖注入
- [ ] RecommendStatisticsLogController.java - 修改查询接口
- [ ] AdminRecommendStatisticsLogController.java - 修改查询接口
- [ ] 所有文件 - 启用缓存清除功能
- [ ] 所有文件 - 添加必要的导入语句
- [ ] 测试验证 - 确保修改后功能正常

## ⚠️ **注意事项**

1. **数据一致性** - 修改后需要验证算力计算结果的准确性
2. **性能影响** - 新服务使用缓存，首次查询可能较慢
3. **向后兼容** - 控制器层需要保持API兼容性
4. **错误处理** - 确保所有异常情况都有适当的处理
5. **日志记录** - 保持详细的日志记录以便调试

## 🔧 **快速修复命令**

```bash
# 1. 添加依赖注入到所有相关文件
# 2. 修改RewardConstructor中的动态奖励方法
# 3. 修改控制器层查询接口
# 4. 启用缓存清除功能
# 5. 添加必要的导入语句
```

完成这些修改后，整个算力系统将完全迁移到新的 `ComputingPowerService`，实现更准确、更实时的算力计算。