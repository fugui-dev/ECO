# 算力计算服务使用示例

## 概述

新的算力计算服务提供了直接从 `PurchaseMinerProject` 表计算算力的功能，替代了原有的 `RecommendStatisticsLog` 统计表方式。

## 核心优势

1. **数据一致性** - 直接从源头查询，避免数据不同步
2. **逻辑清晰** - 递归计算，逻辑简单易懂
3. **性能优化** - 支持Redis缓存，避免重复计算
4. **功能完整** - 覆盖所有算力计算场景
5. **易于维护** - 独立服务，不影响现有代码

## 服务架构

```
ComputingPowerService (接口)
├── ComputingPowerServiceImpl (基础实现)
├── ComputingPowerServiceImplV2 (缓存增强版)
├── ComputingPowerCacheService (缓存服务)
└── ComputingPowerUtil (工具类)
```

## 使用方式

### 1. 基础服务调用

```java
@Resource
private ComputingPowerService computingPowerService;

// 获取用户总算力
SingleResponse<BigDecimal> response = computingPowerService.calculateUserTotalPower(walletAddress, dayTime);
BigDecimal totalPower = response.getData();

// 获取用户自身算力
SingleResponse<BigDecimal> selfPowerResponse = computingPowerService.calculateUserSelfPower(walletAddress, dayTime);

// 获取完整算力信息
SingleResponse<ComputingPowerDTO> infoResponse = computingPowerService.getComputingPowerInfo(walletAddress, dayTime);
ComputingPowerDTO powerInfo = infoResponse.getData();
```

### 2. 工具类调用（推荐）

```java
// 获取当前总算力
BigDecimal todayTotalPower = ComputingPowerUtil.getTodayTotalPower();

// 获取用户总算力
BigDecimal userTotalPower = ComputingPowerUtil.getUserTotalPower(walletAddress);

// 获取用户完整算力信息
ComputingPowerDTO powerInfo = ComputingPowerUtil.getUserComputingPowerInfo(walletAddress);

// 检查用户是否有算力
boolean hasPower = ComputingPowerUtil.hasComputingPower(walletAddress);

// 计算算力占比
BigDecimal ratio = ComputingPowerUtil.calculatePowerRatio(userPower, totalPower);

// 根据算力计算奖励
BigDecimal reward = ComputingPowerUtil.calculateRewardByPower(userPower, totalPower, totalReward);
```

### 3. 缓存增强版

```java
@Resource
private ComputingPowerServiceImplV2 computingPowerServiceV2;

// 使用缓存版本（自动缓存）
SingleResponse<BigDecimal> response = computingPowerServiceV2.calculateUserTotalPower(walletAddress, dayTime);

// 清除用户缓存（矿机状态变化时）
computingPowerServiceV2.invalidateUserCache(walletAddress);

// 清除日期缓存（重新计算某日算力时）
computingPowerServiceV2.invalidateDayCache(dayTime);
```

## 替换现有代码示例

### 1. 奖励计算中的总算力计算

**原代码：**
```java
// 从RecommendStatisticsLog查询总算力
MultiResponse<RecommendStatisticsLogDTO> response = recommendStatisticsLogService.list(recommendStatisticsLogListQry);
BigDecimal totalComputingPower = response.getData()
    .stream()
    .map(RecommendStatisticsLogDTO::getTotalComputingPower)
    .map(BigDecimal::new)
    .reduce(BigDecimal.ZERO, BigDecimal::add);
```

**新代码：**
```java
// 直接计算总算力
BigDecimal totalComputingPower = ComputingPowerUtil.getTotalPower(dayTime);
```

### 2. 静态奖励计算

**原代码：**
```java
BigDecimal staticReward = computingPower.divide(totalComputingPower, 8, RoundingMode.HALF_DOWN).multiply(staticTotalReward);
```

**新代码：**
```java
BigDecimal userPower = ComputingPowerUtil.getUserSelfPower(walletAddress, dayTime);
BigDecimal staticReward = ComputingPowerUtil.calculateRewardByPower(userPower, totalComputingPower, staticTotalReward);
```

### 3. 推荐奖励计算

**原代码：**
```java
BigDecimal directRecommendComputingPower = recommendStatisticsLogList
    .stream()
    .map(RecommendStatisticsLogDTO::getTotalDirectRecommendComputingPower)
    .map(BigDecimal::new)
    .reduce(BigDecimal.ZERO, BigDecimal::add);
```

**新代码：**
```java
BigDecimal directRecommendComputingPower = ComputingPowerUtil.getUserDirectRecommendPower(walletAddress, dayTime);
```

## API接口

### 管理接口

```
GET /admin/computing-power/total?dayTime=2024-01-01
GET /admin/computing-power/user/{walletAddress}?dayTime=2024-01-01
GET /admin/computing-power/user/{walletAddress}/self?dayTime=2024-01-01
GET /admin/computing-power/user/{walletAddress}/recommend?dayTime=2024-01-01
GET /admin/computing-power/user/{walletAddress}/direct?dayTime=2024-01-01
GET /admin/computing-power/user/{walletAddress}/min?dayTime=2024-01-01
GET /admin/computing-power/user/{walletAddress}/new?dayTime=2024-01-01
POST /admin/computing-power/cache/user/{walletAddress}/clear
POST /admin/computing-power/cache/day/{dayTime}/clear
```

## 性能优化

### 1. 缓存策略
- 用户算力信息缓存24小时
- 总算力缓存24小时
- 支持手动清除缓存

### 2. 递归优化
- 使用Map缓存避免重复计算
- 递归深度控制
- 异常处理机制

### 3. 数据库优化
- 使用索引优化查询
- 批量查询减少数据库访问
- 合理的查询条件

## 注意事项

1. **数据一致性** - 矿机状态变化时需要清除相关缓存
2. **性能考虑** - 大量用户时建议使用缓存版本
3. **异常处理** - 所有方法都有异常处理，返回默认值
4. **日期格式** - 统一使用 "yyyy-MM-dd" 格式

## 迁移建议

1. **渐进式替换** - 先在新功能中使用，逐步替换旧代码
2. **并行运行** - 新旧系统并行运行一段时间，确保数据一致性
3. **性能监控** - 监控新服务的性能表现
4. **数据验证** - 定期对比新旧系统的计算结果

## 扩展功能

1. **批量计算** - 支持批量计算多个用户的算力
2. **历史数据** - 支持查询历史算力数据
3. **算力趋势** - 提供算力变化趋势分析
4. **性能统计** - 提供算力计算性能统计