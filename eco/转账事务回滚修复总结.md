# è½¬è´¦äº‹åŠ¡å›æ»šä¿®å¤æ€»ç»“

## ğŸš¨ **é—®é¢˜æè¿°**

åŸå§‹å®ç°ä¸­çš„å¼‚å¸¸å¤„ç†å­˜åœ¨é—®é¢˜ï¼š
```java
} catch (Exception e) {
    log.error("ECOè½¬è´¦å¤±è´¥: ...", e);
    return SingleResponse.buildFailure("è½¬è´¦å¤±è´¥: " + e.getMessage());
}
```

**é—®é¢˜**ï¼šåœ¨ `catch` å—ä¸­ç›´æ¥è¿”å›å¤±è´¥ï¼Œä¸ä¼šè§¦å‘äº‹åŠ¡å›æ»šï¼Œå› ä¸ºå¼‚å¸¸è¢«æ•è·äº†ã€‚

## ğŸ”§ **ä¿®å¤æ–¹æ¡ˆ**

### **1. é‡æ–°æŠ›å‡ºå¼‚å¸¸è§¦å‘å›æ»š**

```java
} catch (Exception e) {
    log.error("ECOè½¬è´¦å¤±è´¥: ...", e);
    // é‡æ–°æŠ›å‡ºå¼‚å¸¸ä»¥è§¦å‘äº‹åŠ¡å›æ»š
    throw new RuntimeException("è½¬è´¦å¤±è´¥: " + e.getMessage(), e);
}
```

### **2. ä¼˜åŒ–å¼‚å¸¸å¤„ç†ç­–ç•¥**

å°†å‚æ•°éªŒè¯å’Œä¸šåŠ¡é€»è¾‘çš„å¼‚å¸¸å¤„ç†åˆ†å¼€ï¼š

```java
@Override
@Retryable(value = OptimisticLockingFailureException.class, maxAttempts = 3, backoff = @Backoff(delay = 100))
@Transactional(isolation = Isolation.REPEATABLE_READ, rollbackFor = Exception.class)
public SingleResponse<Void> transferEco(AccountTransferCmd accountTransferCmd) {
    // å‚æ•°éªŒè¯ï¼ˆåœ¨äº‹åŠ¡å¤–è¿›è¡Œï¼Œé¿å…æ— æ•ˆå‚æ•°è§¦å‘å›æ»šï¼‰
    if (accountTransferCmd.getFromWalletAddress() == null || accountTransferCmd.getFromWalletAddress().trim().isEmpty()) {
        return SingleResponse.buildFailure("è½¬å‡ºé’±åŒ…åœ°å€ä¸èƒ½ä¸ºç©º");
    }
    // ... å…¶ä»–å‚æ•°éªŒè¯
    
    try {
        // ä¸šåŠ¡é€»è¾‘ï¼ˆåœ¨äº‹åŠ¡å†…è¿›è¡Œï¼Œå¼‚å¸¸ä¼šè§¦å‘å›æ»šï¼‰
        // ... è½¬è´¦é€»è¾‘
    } catch (Exception e) {
        log.error("ECOè½¬è´¦å¤±è´¥: ...", e);
        // é‡æ–°æŠ›å‡ºå¼‚å¸¸ä»¥è§¦å‘äº‹åŠ¡å›æ»š
        throw new RuntimeException("è½¬è´¦å¤±è´¥: " + e.getMessage(), e);
    }
}
```

## ğŸ“Š **ä¿®å¤å‰åå¯¹æ¯”**

### **ä¿®å¤å‰ï¼ˆæœ‰é—®é¢˜ï¼‰**
```java
try {
    // ä¸šåŠ¡é€»è¾‘
    // ...
} catch (Exception e) {
    log.error("è½¬è´¦å¤±è´¥", e);
    return SingleResponse.buildFailure("è½¬è´¦å¤±è´¥"); // âŒ ä¸ä¼šè§¦å‘å›æ»š
}
```

**é—®é¢˜**ï¼š
- å¼‚å¸¸è¢«æ•è·ï¼Œä¸ä¼šä¼ æ’­åˆ°Springäº‹åŠ¡ç®¡ç†å™¨
- äº‹åŠ¡ä¸ä¼šå›æ»š
- å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

### **ä¿®å¤åï¼ˆæ­£ç¡®ï¼‰**
```java
try {
    // ä¸šåŠ¡é€»è¾‘
    // ...
} catch (Exception e) {
    log.error("è½¬è´¦å¤±è´¥", e);
    throw new RuntimeException("è½¬è´¦å¤±è´¥", e); // âœ… ä¼šè§¦å‘å›æ»š
}
```

**ä¼˜åŠ¿**ï¼š
- å¼‚å¸¸ä¼šä¼ æ’­åˆ°Springäº‹åŠ¡ç®¡ç†å™¨
- äº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»š
- ä¿è¯æ•°æ®ä¸€è‡´æ€§

## ğŸ”’ **äº‹åŠ¡å›æ»šæœºåˆ¶**

### **Springäº‹åŠ¡å›æ»šæ¡ä»¶**
1. **æœªæ•è·çš„RuntimeException**ï¼šä¼šè‡ªåŠ¨å›æ»š
2. **æœªæ•è·çš„Error**ï¼šä¼šè‡ªåŠ¨å›æ»š
3. **å·²æ•è·çš„å¼‚å¸¸**ï¼šä¸ä¼šå›æ»šï¼ˆé™¤éæ‰‹åŠ¨è°ƒç”¨ `TransactionAspectSupport.currentTransactionStatus().setRollbackOnly()`ï¼‰

### **å½“å‰å®ç°çš„äº‹åŠ¡å›æ»šåœºæ™¯**
1. **æ•°æ®åº“æ“ä½œå¤±è´¥**ï¼šå¦‚ `accountMapper.updateById()` å¤±è´¥
2. **ä¹è§‚é”å†²çª**ï¼šå¦‚ `OptimisticLockingFailureException`
3. **ä¸šåŠ¡é€»è¾‘å¼‚å¸¸**ï¼šå¦‚ä½™é¢ä¸è¶³ç­‰ä¸šåŠ¡è§„åˆ™è¿å
4. **ç³»ç»Ÿå¼‚å¸¸**ï¼šå¦‚ç½‘ç»œè¶…æ—¶ã€æ•°æ®åº“è¿æ¥å¤±è´¥ç­‰

## ğŸ¯ **æœ€ä½³å®è·µ**

### **1. å‚æ•°éªŒè¯åœ¨äº‹åŠ¡å¤–**
```java
// âœ… æ­£ç¡®ï¼šå‚æ•°éªŒè¯åœ¨äº‹åŠ¡å¤–
if (amount == null || amount <= 0) {
    return SingleResponse.buildFailure("å‚æ•°é”™è¯¯");
}

@Transactional
public void businessMethod() {
    // ä¸šåŠ¡é€»è¾‘
}
```

### **2. ä¸šåŠ¡å¼‚å¸¸é‡æ–°æŠ›å‡º**
```java
// âœ… æ­£ç¡®ï¼šé‡æ–°æŠ›å‡ºå¼‚å¸¸è§¦å‘å›æ»š
try {
    // ä¸šåŠ¡é€»è¾‘
} catch (Exception e) {
    log.error("ä¸šåŠ¡æ“ä½œå¤±è´¥", e);
    throw new RuntimeException("æ“ä½œå¤±è´¥", e);
}
```

### **3. ç‰¹å®šå¼‚å¸¸å¤„ç†**
```java
// âœ… æ­£ç¡®ï¼šåªæ•è·ç‰¹å®šå¼‚å¸¸ï¼Œå…¶ä»–å¼‚å¸¸è‡ªåŠ¨å›æ»š
try {
    // ä¸šåŠ¡é€»è¾‘
} catch (BusinessException e) {
    // ä¸šåŠ¡å¼‚å¸¸ï¼Œå¯èƒ½éœ€è¦ç‰¹æ®Šå¤„ç†
    log.warn("ä¸šåŠ¡å¼‚å¸¸: {}", e.getMessage());
    throw e; // é‡æ–°æŠ›å‡ºï¼Œè§¦å‘å›æ»š
} catch (Exception e) {
    // ç³»ç»Ÿå¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡º
    log.error("ç³»ç»Ÿå¼‚å¸¸", e);
    throw new RuntimeException("ç³»ç»Ÿé”™è¯¯", e);
}
```

## âœ… **ä¿®å¤æ•ˆæœ**

1. **æ•°æ®ä¸€è‡´æ€§**ï¼šç¡®ä¿è½¬è´¦æ“ä½œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
2. **å¼‚å¸¸å¤„ç†**ï¼šæ­£ç¡®å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µ
3. **äº‹åŠ¡å®‰å…¨**ï¼šåˆ©ç”¨Springäº‹åŠ¡ç®¡ç†å™¨çš„è‡ªåŠ¨å›æ»šæœºåˆ¶
4. **ä»£ç æ¸…æ™°**ï¼šå‚æ•°éªŒè¯å’Œä¸šåŠ¡é€»è¾‘åˆ†ç¦»ï¼Œä»£ç æ›´æ˜“ç†è§£

## ğŸš€ **æµ‹è¯•å»ºè®®**

### **å›æ»šæµ‹è¯•åœºæ™¯**
1. **ä½™é¢ä¸è¶³**ï¼šè½¬å‡ºè´¦æˆ·ä½™é¢ä¸è¶³æ—¶åº”è¯¥å›æ»š
2. **æ•°æ®åº“å¼‚å¸¸**ï¼šæ•°æ®åº“æ“ä½œå¤±è´¥æ—¶åº”è¯¥å›æ»š
3. **å¹¶å‘å†²çª**ï¼šä¹è§‚é”å†²çªæ—¶åº”è¯¥é‡è¯•æˆ–å›æ»š
4. **ç³»ç»Ÿå¼‚å¸¸**ï¼šç½‘ç»œè¶…æ—¶ç­‰ç³»ç»Ÿå¼‚å¸¸æ—¶åº”è¯¥å›æ»š

### **æµ‹è¯•ä»£ç ç¤ºä¾‹**
```java
@Test
public void testTransferRollback() {
    // è®¾ç½®ä½™é¢ä¸è¶³çš„åœºæ™¯
    when(account.getNumber()).thenReturn("50.00");
    when(transferCmd.getAmount()).thenReturn("100.00");
    
    // æ‰§è¡Œè½¬è´¦
    SingleResponse<Void> response = accountService.transferEco(transferCmd);
    
    // éªŒè¯å›æ»š
    assertFalse(response.isSuccess());
    // éªŒè¯æ•°æ®åº“çŠ¶æ€æœªæ”¹å˜
    verify(accountMapper, never()).updateById(any());
}
```

ç°åœ¨è½¬è´¦åŠŸèƒ½çš„äº‹åŠ¡å›æ»šæœºåˆ¶å·²ç»ä¿®å¤ï¼Œç¡®ä¿äº†æ•°æ®çš„ä¸€è‡´æ€§å’Œå®‰å…¨æ€§ï¼
