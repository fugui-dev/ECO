# æ–°å¢ç®—åŠ›é€’å½’è®¡ç®—ä¿®å¤æ€»ç»“

## ğŸ“Š **ä¿®å¤å‰çš„é—®é¢˜**

### **åŸæœ‰é”™è¯¯é€»è¾‘**
- æ–°å¢ç®—åŠ›åªè®¡ç®—å½“å‰ç”¨æˆ·è‡ªå·±ä»Šå¤©æ–°å¢çš„çŸ¿æœºç®—åŠ›
- æ²¡æœ‰é€’å½’è®¡ç®—å­çº§ä»Šå¤©æ–°å¢çš„ç®—åŠ›
- ä¸ç¬¦åˆä¸šåŠ¡éœ€æ±‚ï¼Œåº”è¯¥åƒå°åŒºç®—åŠ›ä¸€æ ·é€’å½’è®¡ç®—

### **é”™è¯¯ä»£ç ç¤ºä¾‹**
```java
// ä¿®å¤å‰ - åªè®¡ç®—è‡ªå·±çš„æ–°å¢ç®—åŠ›
LambdaQueryWrapper<PurchaseMinerProject> queryWrapper = new LambdaQueryWrapper<>();
queryWrapper.eq(PurchaseMinerProject::getWalletAddress, walletAddress);
// ... åªæŸ¥è¯¢å½“å‰ç”¨æˆ·çš„çŸ¿æœº
```

## ğŸ”§ **ä¿®å¤åçš„æ­£ç¡®é€»è¾‘**

### **æ–°çš„è®¡ç®—æ–¹å¼**
1. **é€’å½’è®¡ç®—**ï¼šè®¡ç®—è‡ªå·±å’Œæ‰€æœ‰å­çº§ä»Šå¤©æ–°å¢çš„ç®—åŠ›
2. **é˜¶æ¢¯è®¡ç®—**ï¼šåº”ç”¨å±‚çº§è´¹ç‡è§„åˆ™
3. **ç¼“å­˜æœºåˆ¶**ï¼šé¿å…é‡å¤è®¡ç®—ï¼Œæé«˜æ€§èƒ½

### **æ ¸å¿ƒæ–¹æ³•**

#### 1. `calculateUserNewPower` - ä¸»å…¥å£æ–¹æ³•
```java
@Override
public SingleResponse<BigDecimal> calculateUserNewPower(String walletAddress, String dayTime, 
                                                       Map<Integer, BigDecimal> levelRateMap, Boolean isLevel) {
    // è·å–ç”¨æˆ·å±‚çº§ä¿¡æ¯
    Integer userLevel = getUserLevel(walletAddress);
    
    // é€’å½’è®¡ç®—æ–°å¢ç®—åŠ› - åŒ…æ‹¬è‡ªå·±å’Œæ‰€æœ‰å­çº§ä»Šå¤©æ–°å¢çš„ç®—åŠ›
    Map<String, BigDecimal> computedPowerMap = new HashMap<>();
    BigDecimal totalNewPower = calculateNewPowerWithLevel(
        userLevel, walletAddress, dayTime, levelRateMap, computedPowerMap, isLevel
    );
    
    return SingleResponse.of(totalNewPower);
}
```

#### 2. `calculateNewPowerWithLevel` - é€’å½’è®¡ç®—æ–¹æ³•
```java
private BigDecimal calculateNewPowerWithLevel(Integer parentLevel, String walletAddress, String dayTime, 
                                             Map<Integer, BigDecimal> levelRateMap, 
                                             Map<String, BigDecimal> cache, Boolean isLevel) {
    // 1. è®¡ç®—å½“å‰ç”¨æˆ·ä»Šå¤©æ–°å¢çš„ç®—åŠ›
    BigDecimal currentNewPower = calculateUserSelfNewPower(walletAddress, dayTime);
    
    // 2. æŸ¥è¯¢ç›´æ¥ä¸‹çº§
    List<Recommend> directSubordinates = getDirectSubordinates(walletAddress);
    
    // 3. é€’å½’è®¡ç®—æ¯ä¸ªä¸‹çº§çš„æ–°å¢ç®—åŠ›
    BigDecimal subordinateNewPower = BigDecimal.ZERO;
    for (Recommend subordinate : directSubordinates) {
        BigDecimal subNewPower = calculateNewPowerWithLevel(/* é€’å½’è°ƒç”¨ */);
        
        // 4. åº”ç”¨é˜¶æ¢¯è®¡ç®—
        if (isLevel && levelRateMap != null) {
            Integer relativeLevel = subordinateLevel - parentLevel;
            BigDecimal levelRate = levelRateMap.get(relativeLevel);
            if (levelRate != null && levelRate.compareTo(BigDecimal.ZERO) > 0) {
                subNewPower = subNewPower.multiply(levelRate);
            }
        }
        
        subordinateNewPower = subordinateNewPower.add(subNewPower);
    }
    
    // 5. æ€»æ–°å¢ç®—åŠ› = è‡ªèº«æ–°å¢ç®—åŠ› + ä¸‹çº§æ–°å¢ç®—åŠ›
    return currentNewPower.add(subordinateNewPower);
}
```

#### 3. `calculateUserSelfNewPower` - è®¡ç®—è‡ªèº«æ–°å¢ç®—åŠ›
```java
private BigDecimal calculateUserSelfNewPower(String walletAddress, String dayTime) {
    // æŸ¥è¯¢å½“æ—¥æ–°å¢çš„çŸ¿æœº
    long startTime = getDayStartTime(dayTime);
    long endTime = getDayEndTime(dayTime);
    
    List<PurchaseMinerProject> newMiners = queryNewMiners(walletAddress, startTime, endTime);
    
    // è®¡ç®—è‡ªèº«æ–°å¢ç®—åŠ›
    return newMiners.stream()
            .map(miner -> new BigDecimal(miner.getActualComputingPower()))
            .reduce(BigDecimal.ZERO, BigDecimal::add);
}
```

## ğŸ“Š **ç®—åŠ›å±‚çº§ç»“æ„ç¤ºä¾‹**

```
ç”¨æˆ·A (3çº§)
â”œâ”€â”€ è‡ªèº«ä»Šå¤©æ–°å¢ç®—åŠ›: 100
â”œâ”€â”€ ç›´æ¨B (4çº§) ä»Šå¤©æ–°å¢ç®—åŠ›: 200
â”‚   â”œâ”€â”€ Bçš„å­çº§1 (5çº§) ä»Šå¤©æ–°å¢ç®—åŠ›: 150
â”‚   â””â”€â”€ Bçš„å­çº§2 (5çº§) ä»Šå¤©æ–°å¢ç®—åŠ›: 300
â””â”€â”€ ç›´æ¨C (4çº§) ä»Šå¤©æ–°å¢ç®—åŠ›: 180
    â””â”€â”€ Cçš„å­çº§1 (5çº§) ä»Šå¤©æ–°å¢ç®—åŠ›: 120

è®¡ç®—è¿‡ç¨‹ï¼š
1. Aè‡ªèº«æ–°å¢ç®—åŠ›: 100
2. BåŠå…¶å­çº§æ–°å¢ç®—åŠ›: 200 + (150 + 300) = 650
   - åº”ç”¨é˜¶æ¢¯è®¡ç®—: 650 * levelRate[4-3] = 650 * 0.8 = 520
3. CåŠå…¶å­çº§æ–°å¢ç®—åŠ›: 180 + 120 = 300
   - åº”ç”¨é˜¶æ¢¯è®¡ç®—: 300 * levelRate[4-3] = 300 * 0.8 = 240
4. Açš„æ€»æ–°å¢ç®—åŠ›: 100 + 520 + 240 = 860
```

## ğŸ”„ **ä¸å°åŒºç®—åŠ›çš„å¯¹æ¯”**

| ç‰¹æ€§ | å°åŒºç®—åŠ› | æ–°å¢ç®—åŠ› |
|------|----------|----------|
| **è®¡ç®—èŒƒå›´** | æ‰€æœ‰å­çº§çš„æ€»ç®—åŠ› | æ‰€æœ‰å­çº§ä»Šå¤©æ–°å¢çš„ç®—åŠ› |
| **é€’å½’æ–¹å¼** | é€’å½’è®¡ç®—æ€»ç®—åŠ› | é€’å½’è®¡ç®—æ–°å¢ç®—åŠ› |
| **é˜¶æ¢¯è®¡ç®—** | æ”¯æŒ | æ”¯æŒ |
| **ç¼“å­˜æœºåˆ¶** | æ”¯æŒ | æ”¯æŒ |
| **è®¡ç®—é€»è¾‘** | è‡ªèº«ç®—åŠ› + å­çº§ç®—åŠ› | è‡ªèº«æ–°å¢ç®—åŠ› + å­çº§æ–°å¢ç®—åŠ› |

## âœ… **ä¿®å¤éªŒè¯**

### **ä¿®å¤å‰**
- âŒ åªè®¡ç®—è‡ªå·±çš„æ–°å¢ç®—åŠ›
- âŒ æ²¡æœ‰é€’å½’è®¡ç®—å­çº§
- âŒ ä¸ç¬¦åˆä¸šåŠ¡éœ€æ±‚

### **ä¿®å¤å**
- âœ… é€’å½’è®¡ç®—è‡ªå·±å’Œæ‰€æœ‰å­çº§çš„æ–°å¢ç®—åŠ›
- âœ… æ”¯æŒé˜¶æ¢¯è®¡ç®—è§„åˆ™
- âœ… ä½¿ç”¨ç¼“å­˜æœºåˆ¶æé«˜æ€§èƒ½
- âœ… ä¸å°åŒºç®—åŠ›è®¡ç®—é€»è¾‘ä¿æŒä¸€è‡´

## ğŸš€ **ä½¿ç”¨æ–¹å¼**

```java
// è·å–å±‚çº§è´¹ç‡æ˜ å°„
Map<Integer, BigDecimal> levelRateMap = getLevelRateMap();

// è®¡ç®—æ–°å¢ç®—åŠ›ï¼ˆé€’å½’é˜¶æ¢¯è®¡ç®—ï¼‰
SingleResponse<BigDecimal> newPowerResponse = computingPowerService.calculateUserNewPower(
    walletAddress, 
    dayTime, 
    levelRateMap, 
    true  // å¯ç”¨é˜¶æ¢¯è®¡ç®—
);
```

## ğŸ“ **æ³¨æ„äº‹é¡¹**

1. **å±‚çº§å·®è®¡ç®—**ï¼š`relativeLevel = subordinateLevel - parentLevel`
2. **é˜¶æ¢¯è´¹ç‡**ï¼šæ ¹æ®å±‚çº§å·®ä» `levelRateMap` è·å–å¯¹åº”è´¹ç‡
3. **ç¼“å­˜æœºåˆ¶**ï¼šé¿å…é‡å¤è®¡ç®—ï¼Œæé«˜æ€§èƒ½
4. **å¼‚å¸¸å¤„ç†**ï¼šè®¡ç®—å¤±è´¥æ—¶è¿”å› `BigDecimal.ZERO`
5. **æ—¥å¿—è®°å½•**ï¼šè®°å½•è®¡ç®—è¿‡ç¨‹å’Œç»“æœï¼Œä¾¿äºè°ƒè¯•

ä¿®å¤å®Œæˆï¼æ–°å¢ç®—åŠ›ç°åœ¨å¯ä»¥æ­£ç¡®é€’å½’è®¡ç®—æ‰€æœ‰å­çº§ä»Šå¤©æ–°å¢çš„ç®—åŠ›ï¼Œå¹¶åº”ç”¨é˜¶æ¢¯è®¡ç®—è§„åˆ™ã€‚
