# 代币转账同步功能配置说明

## 📋 功能概述

本功能用于同步以太坊网络上的代币转账记录，特别是用户向管理合约地址转入代币的充值行为。

## 🏗️ 架构设计

### 核心组件

1. **TokenTransferLog** - 代币转账记录实体类
2. **EtherScanTokenTransferDTO** - Etherscan API响应DTO
3. **TokenTransferScheduled** - 定时同步任务
4. **TokenTransferService** - 业务服务层
5. **AdminTokenTransferController** - 管理端API

### 数据流程

```
Etherscan API → TokenTransferScheduled → TokenTransferLog → TokenTransferService → AdminController
```

## ⚙️ 配置要求

### 1. 数据库配置

执行 `token_transfer_log.sql` 创建数据表。

### 2. 系统配置

在 `system_config` 表中添加以下配置：

```sql
-- API密钥
INSERT INTO system_config (`name`, `value`, `description`) VALUES 
('API_KEY', 'YOUR_ETHERSCAN_API_KEY', 'Etherscan API密钥');

-- ESG管理合约地址
INSERT INTO system_config (`name`, `value`, `description`) VALUES 
('ESG_MANAGEMENT_CONTRACT', '0x4fC335d41CCAfBa07d2499f994965E4d142440E8', 'ESG代币管理合约地址');

-- ECO管理合约地址
INSERT INTO system_config (`name`, `value`, `description`) VALUES 
('ECO_MANAGEMENT_CONTRACT', '0xe729fE3c368B36F7dEa0Ed545426ff7c6bFA4c0D', 'ECO代币管理合约地址');
```

### 3. 应用配置

在 `application.properties` 中配置：

```properties
# Etherscan API地址
ether.scan.transaction.url=https://api.etherscan.io/api
```

## 🚀 功能特性

### 1. 自动同步

- **频率**: 每10分钟执行一次
- **范围**: 同步ESG和ECO两种代币的转账记录
- **增量**: 从最后同步的区块开始继续同步
- **去重**: 自动跳过已存在的记录

### 2. 数据解析

- **API接口**: 使用 `tokentx` 接口获取代币转账记录
- **金额格式化**: 根据代币精度自动格式化金额
- **状态识别**: 自动识别交易成功/失败状态

### 3. 业务处理

- **充值检查**: 定期检查未处理的充值记录
- **状态更新**: 自动标记已处理的记录
- **错误处理**: 完善的异常处理和日志记录

## 📊 API接口

### 管理端接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/admin/token-transfer/list` | GET | 获取转账记录列表 |
| `/admin/token-transfer/{hash}` | GET | 根据哈希获取记录 |
| `/admin/token-transfer/check-deposit` | POST | 检查充值记录 |
| `/admin/token-transfer/sync` | POST | 手动同步记录 |

### 请求参数

#### 获取列表
- `tokenType`: 代币类型 (ESG/ECO)
- `fromAddress`: 发送方地址
- `toAddress`: 接收方地址
- `status`: 状态 (SUCCESS/FAILED/PENDING)
- `pageNum`: 页码 (默认1)
- `pageSize`: 页大小 (默认20)

#### 检查充值
- `tokenType`: 代币类型 (ESG/ECO)

#### 手动同步
- `tokenType`: 代币类型 (ESG/ECO)

## 🔧 使用说明

### 1. 启动同步

系统启动后会自动开始同步，无需手动操作。

### 2. 查看记录

通过管理端API可以查看同步的转账记录。

### 3. 处理充值

调用检查充值接口处理用户的充值行为。

### 4. 手动同步

如需要立即同步，可调用手动同步接口。

## 📝 注意事项

1. **API限制**: Etherscan API有调用频率限制，已添加1秒延迟
2. **网络异常**: 网络异常时会自动跳过，下次继续同步
3. **数据一致性**: 使用事务确保数据一致性
4. **日志记录**: 详细的操作日志便于问题排查

## 🐛 故障排查

### 常见问题

1. **同步失败**: 检查API密钥和网络连接
2. **数据重复**: 检查数据库唯一索引
3. **金额错误**: 检查代币精度配置
4. **状态异常**: 检查交易状态解析逻辑

### 日志关键字

- `开始同步代币转账记录`
- `成功同步{}条转账记录`
- `Etherscan API返回错误`
- `处理充值记录失败`
