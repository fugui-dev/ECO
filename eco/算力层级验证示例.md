# ç®—åŠ›å±‚çº§éªŒè¯ç¤ºä¾‹

## ğŸ“Š **å¤æ‚å±‚çº§ç»“æ„ç¤ºä¾‹**

```
ç”¨æˆ·A
â”œâ”€â”€ ç›´æ¨B (è‡ªèº«ç®—åŠ›=100 + Bçš„æ‰€æœ‰ä¸‹çº§ç®—åŠ›=500) = 600æ€»ç®—åŠ›
â”‚   â”œâ”€â”€ Bçš„å­çº§1 (è‡ªèº«=50 + ä¸‹çº§=100) = 150
â”‚   â”‚   â””â”€â”€ Bçš„å­çº§1çš„å­çº§ (è‡ªèº«=100) = 100
â”‚   â””â”€â”€ Bçš„å­çº§2 (è‡ªèº«=200 + ä¸‹çº§=150) = 350
â”‚       â”œâ”€â”€ Bçš„å­çº§2çš„å­çº§1 (è‡ªèº«=100) = 100
â”‚       â””â”€â”€ Bçš„å­çº§2çš„å­çº§2 (è‡ªèº«=50) = 50
â”œâ”€â”€ ç›´æ¨C (è‡ªèº«ç®—åŠ›=200 + Cçš„æ‰€æœ‰ä¸‹çº§ç®—åŠ›=300) = 500æ€»ç®—åŠ›
â”‚   â”œâ”€â”€ Cçš„å­çº§1 (è‡ªèº«=100 + ä¸‹çº§=100) = 200
â”‚   â”‚   â””â”€â”€ Cçš„å­çº§1çš„å­çº§ (è‡ªèº«=100) = 100
â”‚   â””â”€â”€ Cçš„å­çº§2 (è‡ªèº«=100) = 100
â”œâ”€â”€ ç›´æ¨D (è‡ªèº«ç®—åŠ›=300 + Dçš„æ‰€æœ‰ä¸‹çº§ç®—åŠ›=400) = 700æ€»ç®—åŠ›
â”‚   â”œâ”€â”€ Dçš„å­çº§1 (è‡ªèº«=200 + ä¸‹çº§=100) = 300
â”‚   â”‚   â””â”€â”€ Dçš„å­çº§1çš„å­çº§ (è‡ªèº«=100) = 100
â”‚   â””â”€â”€ Dçš„å­çº§2 (è‡ªèº«=100) = 100
â””â”€â”€ ç›´æ¨E (è‡ªèº«ç®—åŠ›=150 + Eçš„æ‰€æœ‰ä¸‹çº§ç®—åŠ›=250) = 400æ€»ç®—åŠ›
    â”œâ”€â”€ Eçš„å­çº§1 (è‡ªèº«=100 + ä¸‹çº§=50) = 150
    â”‚   â””â”€â”€ Eçš„å­çº§1çš„å­çº§ (è‡ªèº«=50) = 50
    â””â”€â”€ Eçš„å­çº§2 (è‡ªèº«=100) = 100
```

## ğŸ” **ç®—åŠ›è®¡ç®—è¿‡ç¨‹**

### **1. è®¡ç®—æ¯ä¸ªç›´æ¨çš„æ€»ç®—åŠ›**

**ç›´æ¨Bçš„æ€»ç®—åŠ›ï¼š**
- è‡ªèº«ç®—åŠ›ï¼š100
- ä¸‹çº§ç®—åŠ›ï¼š150 + 350 = 500
- **æ€»ç®—åŠ›ï¼š100 + 500 = 600**

**ç›´æ¨Cçš„æ€»ç®—åŠ›ï¼š**
- è‡ªèº«ç®—åŠ›ï¼š200
- ä¸‹çº§ç®—åŠ›ï¼š200 + 100 = 300
- **æ€»ç®—åŠ›ï¼š200 + 300 = 500**

**ç›´æ¨Dçš„æ€»ç®—åŠ›ï¼š**
- è‡ªèº«ç®—åŠ›ï¼š300
- ä¸‹çº§ç®—åŠ›ï¼š300 + 100 = 400
- **æ€»ç®—åŠ›ï¼š300 + 400 = 700**

**ç›´æ¨Eçš„æ€»ç®—åŠ›ï¼š**
- è‡ªèº«ç®—åŠ›ï¼š150
- ä¸‹çº§ç®—åŠ›ï¼š150 + 100 = 250
- **æ€»ç®—åŠ›ï¼š150 + 250 = 400**

### **2. è®¡ç®—ç»“æœ**

- **ç›´æ¨ç®—åŠ›æ€»å’Œ** = 600 + 500 + 700 + 400 = 2200
- **æœ€å¤§ç›´æ¨ç®—åŠ›** = 700ï¼ˆç›´æ¨Dï¼‰
- **æœ€å¤§ç›´æ¨åœ°å€** = ç›´æ¨Dçš„é’±åŒ…åœ°å€
- **å°åŒºç®—åŠ›** = 600 + 500 + 400 = 1500ï¼ˆé™¤äº†ç›´æ¨Då¤–çš„å…¶ä»–ç›´æ¨ç®—åŠ›æ€»å’Œï¼‰

## âœ… **ä»£ç å®ç°éªŒè¯**

### **calculateUserTotalPower æ–¹æ³•**
```java
// æ€»ç®—åŠ› = è‡ªèº«ç®—åŠ› + æ¨èç®—åŠ›ï¼ˆæ‰€æœ‰ä¸‹çº§ï¼‰
BigDecimal selfPower = calculateUserSelfPower(walletAddress, dayTime);
BigDecimal recommendPower = calculateSubordinatePower(walletAddress, dayTime, cache);
BigDecimal totalPower = selfPower.add(recommendPower);
```

### **calculateSubordinatePower é€’å½’æ–¹æ³•**
```java
private BigDecimal calculateSubordinatePower(String walletAddress, String dayTime, Map<String, BigDecimal> cache) {
    // 1. è®¡ç®—å½“å‰ç”¨æˆ·çš„è‡ªèº«ç®—åŠ›
    BigDecimal currentPower = calculateUserSelfPower(walletAddress, dayTime);
    
    // 2. æŸ¥è¯¢ç›´æ¥ä¸‹çº§
    List<Recommend> directSubordinates = recommendMapper.selectList(queryWrapper);
    
    // 3. é€’å½’è®¡ç®—æ¯ä¸ªä¸‹çº§çš„ç®—åŠ›
    BigDecimal subordinatePower = BigDecimal.ZERO;
    for (Recommend subordinate : directSubordinates) {
        BigDecimal subPower = calculateSubordinatePower(subordinate.getWalletAddress(), dayTime, cache);
        subordinatePower = subordinatePower.add(subPower);
    }
    
    // 4. æ€»ç®—åŠ› = è‡ªèº«ç®—åŠ› + ä¸‹çº§ç®—åŠ›
    BigDecimal totalPower = currentPower.add(subordinatePower);
    
    return totalPower;
}
```

### **maxPower å’Œ minPower è®¡ç®—**
```java
// 1. è®¡ç®—æ¯ä¸ªç›´æ¨çš„æ€»ç®—åŠ›
Map<String, BigDecimal> directPowerMap = new HashMap<>();
for (Recommend directRecommend : directRecommends) {
    SingleResponse<BigDecimal> totalPowerResponse = calculateUserTotalPower(directRecommend.getWalletAddress(), dayTime);
    if (totalPowerResponse.isSuccess()) {
        directPowerMap.put(directRecommend.getWalletAddress(), totalPowerResponse.getData());
    }
}

// 2. æ‰¾åˆ°æœ€å¤§ç®—åŠ›çš„ç”¨æˆ·
String maxWalletAddress = directPowerMap.entrySet().stream()
        .max(Map.Entry.comparingByValue())
        .map(Map.Entry::getKey)
        .orElse(null);

// 3. è®¡ç®—é™¤æœ€å¤§ç®—åŠ›å¤–çš„å…¶ä»–ç›´æ¨ç®—åŠ›æ€»å’Œ
BigDecimal minPower = directPowerMap.entrySet().stream()
        .filter(entry -> !entry.getKey().equals(maxWalletAddress))
        .map(Map.Entry::getValue)
        .reduce(BigDecimal.ZERO, BigDecimal::add);
```

## ğŸ¯ **ç»“è®º**

å½“å‰çš„å®ç°**å®Œå…¨æ­£ç¡®**ï¼å®ƒèƒ½å¤Ÿï¼š

1. âœ… **é€’å½’è®¡ç®—**æ¯ä¸ªç”¨æˆ·çš„æ€»ç®—åŠ›ï¼ˆè‡ªèº« + æ‰€æœ‰ä¸‹çº§ï¼‰
2. âœ… **æ­£ç¡®å¤„ç†**å¤æ‚çš„å¤šå±‚çº§ç»“æ„
3. âœ… **å‡†ç¡®è®¡ç®—**æœ€å¤§ç›´æ¨ç®—åŠ›å’Œå°åŒºç®—åŠ›
4. âœ… **ä½¿ç”¨ç¼“å­˜**é¿å…é‡å¤è®¡ç®—ï¼Œæé«˜æ€§èƒ½

æ— è®ºBã€Cã€Dã€Eä¸‹é¢æœ‰å¤šå°‘å±‚å­çº§ï¼Œè¿™ä¸ªå®ç°éƒ½èƒ½æ­£ç¡®è®¡ç®—å‡ºæ¯ä¸ªç›´æ¨çš„**æ€»ç®—åŠ›**ï¼Œç„¶åæ‰¾å‡ºæœ€å¤§çš„é‚£ä¸ªï¼Œå¹¶è®¡ç®—å°åŒºç®—åŠ›ã€‚